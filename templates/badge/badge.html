{% extends "badge/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
            <h2 class="mb-0 h5 d-flex align-items-center gap-2">
                <i class="fas fa-id-badge"></i> Badges
            </h2>
            <!-- Generate Batch ZIPs Button -->
            <a href="#" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#batchModal">
                <i class="fas fa-layer-group me-1"></i> Generate Batch ZIPs
            </a>
        </div>
        <div class="card-body text-center py-5">
            <p class="text-muted mb-0">Click the button above to generate badge ZIP files for delegates. Default batch is 100 badges per zip but can be increase depending on the requirements</p>
        </div>
    </div>
</div>

<!-- Batch Generation Modal -->
<div class="modal fade" id="batchModal" tabindex="-1" aria-labelledby="batchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <form id="batchForm" method="get" action="{% url 'generate_all_exhibitor_badges' %}">
                <div class="modal-header bg-primary text-white p-4 rounded-top-4">
                    <h5 class="modal-title fw-bold" id="batchModalLabel">Generate Badge Batches</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label fw-semibold">Start Date</label>
                            <input type="date" name="start_date" id="startDate" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label fw-semibold">End Date</label>
                            <input type="date" name="end_date" id="endDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="categorySelect" class="form-label fw-semibold">Category</label>
                        <select name="category" id="categorySelect" class="form-select">
                            <option value="">All Categories</option>
                            {% for value, label in categories %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <p id="countDisplay" class="text-center text-muted small mt-2">
                        Select a date range and category to see how many registrations are included.
                    </p>
                    <div class="mt-3">
                        <label class="form-label fw-semibold">Badges per Batch</label>
                        <input type="number" name="batch_size" class="form-control" min="1" max="100" value="100" required>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between flex-wrap p-3 border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success d-flex align-items-center gap-1">
                        <i class="fas fa-download"></i> Generate ZIPs
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Spinner Overlay -->
<div id="spinnerOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none bg-light bg-opacity-75 d-flex justify-content-center align-items-center flex-column text-center" style="z-index:3000;">
    <div class="spinner-border text-primary mb-3" role="status" style="width:3rem;height:3rem;"></div>
    <p class="fw-semibold text-primary">Generating badges... Please wait.</p>
</div>

<style>
/* Card Styling */
.card { border-radius: 0.5rem; }
.card-header h2 { font-weight: 600; }
.card-body p { font-size: 0.95rem; color: #6c757d; }

/* Modal Gradient Header */
.bg-primary { background: linear-gradient(135deg,#2980b9,#6dd5fa); }
.modal-header .modal-title { font-size: 1.25rem; }

/* Spinner Overlay */
#spinnerOverlay { transition: opacity 0.3s; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const categorySelect = document.getElementById("categorySelect");
    const countDisplay = document.getElementById("countDisplay");
    const form = document.getElementById("batchForm");
    const spinner = document.getElementById("spinnerOverlay");

    // Update registration count dynamically
    async function updateCount() {
        const start = startDate.value;
        const end = endDate.value;
        const category = categorySelect.value;

        if (!start || !end) return;
        countDisplay.textContent = "Counting registrations...";

        try {
            const url = new URL("{% url 'count_registrations_in_range' %}", window.location.origin);
            url.searchParams.append("start_date", start);
            url.searchParams.append("end_date", end);
            if (category) url.searchParams.append("category", category);

            const response = await fetch(url);
            const data = await response.json();
            countDisplay.textContent = data.count + " registration" + (data.count === 1 ? "" : "s") + " found in this range.";
        } catch (error) {
            console.error(error);
            countDisplay.textContent = "Error fetching registration count.";
        }
    }

    [startDate, endDate, categorySelect].forEach(el => el.addEventListener("change", updateCount));

    // Handle batch form submit
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        spinner.classList.remove("d-none");

        const formData = new FormData(form);
        const params = new URLSearchParams(formData).toString();
        const url = `{% url 'generate_all_exhibitor_badges' %}?${params}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Failed to generate ZIP");

            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = downloadUrl;
            link.download = "Software_Summit_Badges.zip";
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(downloadUrl);
        } catch (error) {
            console.error(error);
            alert("There was an error generating the ZIP file.");
        } finally {
            setTimeout(() => spinner.classList.add("d-none"), 1000);
        }
    });
});
</script>
{% endblock %}
