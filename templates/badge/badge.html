{% extends "badge/base.html" %}
{% load static %}

{% block content %}
    <div class="container mt-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0 h4">
                    <i class="fas fa-id-badge me-2"></i>Badges to Print
                </h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <div class="mb-3 d-flex justify-content-between">
                        <button id="massPrintBtn" class="btn btn-success btn-sm">
                            <i class="fas fa-print me-1"></i> Print Selected
                        </button>
                    </div>

                    <table id="badge-table" class="table table-hover table-bordered align-middle">
                        <thead class="table-dark">
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all" title="Select All">
                            </th>
                            <th style="width: 50px;">#</th>
                            <th>Title</th>
                            <th>First Name</th>
                            <th>Other Names</th>
                            <th>National ID</th>
                            <th>Org. Type</th>
                            <th>Job Title</th>
                            <th>Days to Attend</th>
                            <th style="width: 80px;">Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for registrant in registrants %}
                            <tr id="row-{{ registrant.id }}">
                                <td class="text-center">
                                    <input type="checkbox" class="select-item" value="{{ registrant.id }}">
                                </td>
                                <td class="text-center">{{ forloop.counter }}</td>
                                <td>{{ registrant.title }}</td>
                                <td class="fw-semibold text-primary">{{ registrant.first_name }}</td>
                                <td class="fw-semibold">{{ registrant.second_name }}</td>
                                <td class="text-muted">{{ registrant.national_id_number|default:"—" }}</td>
                                <td><span class="badge bg-info text-dark">{{ registrant.display_org_type }}</span></td>
                                <td>{{ registrant.job_title|default:"—" }}</td>
                                <td>{{ registrant.days_to_attend|default:"—" }}</td>
                                <td class="text-center">
                                    <button
                                            class="btn btn-sm btn-primary"
                                            title="Generate Badge"
                                            onclick="openBadgeModal({{ registrant.id }})">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </td>

                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-print fa-3x mb-3 d-block"></i>
                                    No Pending Badge Available.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Badge Preview Modal - Enhanced Design -->
    <div class="modal fade" id="badgeModal" tabindex="-1" role="dialog" aria-labelledby="badgeModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content modern-modal">
                <div class="modal-header-custom">
                    <div class="modal-icon-wrapper">
                        <i class="fas fa-id-badge"></i>
                    </div>
                    <div class="modal-title-wrapper">
                        <h5 class="modal-title-main" id="badgeModalLabel">Badge Preview</h5>
                        <p class="modal-subtitle">Review before printing</p>
                    </div>
                    <button type="button" class="close-btn-custom" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body-custom">
                    <!-- Loading State -->
                    <div id="badgeLoading" class="loading-container">
                        <div class="spinner-wrapper">
                            <div class="spinner-custom"></div>
                        </div>
                        <p class="loading-text">Generating your badge</p>
                        <p class="loading-subtext">Please wait a moment...</p>
                    </div>

                    <!-- Badge Preview -->
                    <div class="badge-preview-container d-none">
                        <div class="preview-frame">
                            <img id="badgePreview" src="" alt="Badge" class="badge-image">
                            <div class="preview-overlay">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">
                        <i class="fas fa-times-circle me-2"></i>Cancel
                    </button>
                    <button type="button" id="printBadgeBtn" class="btn-print d-none" onclick="printBadge()">
                        <i class="fas fa-print me-2"></i>Print Badge
                    </button>
                </div>
            </div>
        </div>
    </div>


    <style>
        #badge-table {
            font-size: 0.9rem;
        }

        #badge-table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            border-bottom: 3px solid #495057 !important;
        }

        #badge-table tbody tr {
            transition: all 0.2s ease;
            border-bottom: 2px solid #dee2e6;
        }

        #badge-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        #badge-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }

        #badge-table tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.1) !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #badge-table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-right: 1px solid #e9ecef;
        }

        #badge-table tbody td:last-child {
            border-right: none;
        }

        #badge-table th:first-child, #badge-table td:first-child {
            text-align: center;
            vertical-align: middle;
        }

        .dataTables_wrapper .dt-buttons {
            float: none;
            display: flex;
            gap: 0.5rem;
        }

        .dataTables_wrapper .dt-buttons .btn {
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .card {
            border: none;
            border-radius: 0.5rem;
        }

        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }

        /* ==================== MODERN MODAL STYLES ==================== */

        .modern-modal {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #2980b9 0%, #6dd5fa 50%, #ffffff 100%);
        }

        /* Custom Header */
        .modal-header-custom {
            background: linear-gradient(135deg, #2980b9 0%, #6dd5fa 50%, #ffffff 100%);
            padding: 2rem;
            border: none;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
        }

        .modal-icon-wrapper {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .modal-title-wrapper {
            flex: 1;
        }

        .modal-title-main {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9rem;
            margin: 0.25rem 0 0 0;
        }

        .close-btn-custom {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            color: slategrey;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn-custom:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Custom Body */
        .modal-body-custom {
            background: white;
            padding: 3rem 2rem;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading Animation */
        .loading-container {
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .spinner-wrapper {
            margin-bottom: 1.5rem;
        }

        .spinner-custom {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }

        .loading-subtext {
            color: #999;
            font-size: 0.9rem;
            margin: 0;
        }

        /* Badge Preview Container */
        .badge-preview-container {
            width: 100%;
            animation: fadeIn 0.5s ease;
        }

        .preview-frame {
            position: relative;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .preview-frame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .badge-image {
            width: 100%;
            height: auto;
            max-height: 600px;
            object-fit: contain;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .preview-frame:hover .badge-image {
            transform: scale(1.02);
        }

        .preview-overlay {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 40px;
            height: 40px;
            background: rgba(102, 126, 234, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .preview-frame:hover .preview-overlay {
            opacity: 1;
        }

        /* Custom Footer */
        .modal-footer-custom {
            background: #f8f9fa;
            padding: 1.5rem 2rem;
            border: none;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-cancel {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e0e0e0;
            background: white;
            color: #666;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #f5f5f5;
            border-color: #ccc;
            transform: translateY(-2px);
        }

        .btn-print {
            padding: 0.75rem 2rem;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-print:active {
            transform: translateY(0);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal backdrop enhancement */
        .modal.fade .modal-dialog {
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }

        .modal.show .modal-dialog {
            transform: scale(1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-header-custom {
                padding: 1.5rem;
                gap: 1rem;
            }

            .modal-icon-wrapper {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .modal-title-main {
                font-size: 1.2rem;
            }

            .modal-body-custom {
                padding: 2rem 1rem;
            }

            .modal-footer-custom {
                flex-direction: column;
            }

            .btn-cancel,
            .btn-print {
                width: 100%;
            }
        }
    </style>
{% endblock %}

{% block scripts %}
    <link rel="stylesheet" href="{% static 'datatables/css/jquery.dataTables.min.css' %}">
    <link rel="stylesheet" href="{% static 'datatables/css/buttons.dataTables.min.css' %}">
    <script src="{% static 'datatables/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'datatables/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'datatables/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'datatables/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'datatables/js/jszip.min.js' %}"></script>
    <script src="{% static 'datatables/js/pdfmake.min.js' %}"></script>
    <script src="{% static 'datatables/js/vfs_fonts.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize DataTable
            $('#badge-table').DataTable({
                responsive: true,
                dom: '<"d-flex justify-content-between align-items-center mb-3"f>rtip',
                pageLength: 5,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                language: {
                    search: "Search delegates:",
                    lengthMenu: "Show _MENU_ delegates per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ delegates",
                    infoEmpty: "No delegates found",
                    infoFiltered: "(filtered from _MAX_ total delegates)"
                }
            });

            // Handle "Select All" checkbox
            const selectAll = document.getElementById("select-all");
            const checkboxes = document.querySelectorAll(".select-item");

            selectAll.addEventListener("change", function () {
                checkboxes.forEach(cb => cb.checked = this.checked);
            });

            // Handle Mass Print Button
            document.getElementById("massPrintBtn").addEventListener("click", function () {
                const selected = Array.from(document.querySelectorAll(".select-item:checked"))
                    .map(cb => cb.value);

                if (selected.length === 0) {
                    alert("Please select at least one record.");
                    return;
                }

                // Open modal with multiple badges
                openMassBadgeModal(selected);
            });
        });

        // Store current batch of IDs being processed
        let currentBatchIds = [];
        let currentBadgeIndex = 0;
        let badgeImages = [];

        // Open modal for mass badge preview
        function openMassBadgeModal(ids) {
            currentBatchIds = ids;
            currentBadgeIndex = 0;
            badgeImages = [];

            const modal = new bootstrap.Modal(document.getElementById("badgeModal"));
            const modalTitle = document.querySelector(".modal-title-main");
            const modalSubtitle = document.querySelector(".modal-subtitle");

            modalTitle.textContent = `Badge Preview (${ids.length} selected)`;
            modalSubtitle.textContent = `Loading badges...`;

            const previewContainer = document.querySelector(".badge-preview-container");
            const loading = document.getElementById("badgeLoading");
            const printBtn = document.getElementById("printBadgeBtn");

            previewContainer.classList.add("d-none");
            loading.classList.remove("d-none");
            printBtn.classList.add("d-none");

            modal.show();

            // Fetch all badges
            loadAllBadges(ids);
        }

        // Load all selected badges
        async function loadAllBadges(ids) {
            const loading = document.getElementById("badgeLoading");
            const loadingText = loading.querySelector(".loading-text");
            const loadingSubtext = loading.querySelector(".loading-subtext");

            try {
                for (let i = 0; i < ids.length; i++) {
                    loadingText.textContent = `Loading badge ${i + 1} of ${ids.length}`;
                    loadingSubtext.textContent = `Please wait...`;

                    const response = await fetch(`/create_badge/${ids[i]}/`);
                    const data = await response.json();

                    if (data.image_url) {
                        badgeImages.push({
                            id: ids[i],
                            url: data.image_url
                        });
                    } else {
                        console.error(`Failed to load badge for ID: ${ids[i]}`);
                    }
                }

                if (badgeImages.length > 0) {
                    displayBadgeCarousel();
                } else {
                    loading.innerHTML = "<p class='text-danger'>Failed to load any badges.</p>";
                }
            } catch (err) {
                console.error("Error loading badges:", err);
                loading.innerHTML = "<p class='text-danger'>Error loading badges.</p>";
            }
        }

        // Display badges in a carousel format
        function displayBadgeCarousel() {
            const previewContainer = document.querySelector(".badge-preview-container");
            const loading = document.getElementById("badgeLoading");
            const printBtn = document.getElementById("printBadgeBtn");
            const modalSubtitle = document.querySelector(".modal-subtitle");

            loading.classList.add("d-none");
            previewContainer.classList.remove("d-none");
            printBtn.classList.remove("d-none");

            modalSubtitle.textContent = `Showing badge ${currentBadgeIndex + 1} of ${badgeImages.length}`;

            // Update preview container with navigation
            previewContainer.innerHTML = `
        <div class="badge-navigation mb-3 text-center">
            <button class="btn btn-sm btn-outline-primary" id="prevBadge" ${currentBadgeIndex === 0 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span class="mx-3 fw-bold">Badge ${currentBadgeIndex + 1} of ${badgeImages.length}</span>
            <button class="btn btn-sm btn-outline-primary" id="nextBadge" ${currentBadgeIndex === badgeImages.length - 1 ? 'disabled' : ''}>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="preview-frame">
            <img id="badgePreview" src="${badgeImages[currentBadgeIndex].url}" alt="Badge" class="badge-image">
            <div class="preview-overlay">
                <i class="fas fa-search-plus"></i>
            </div>
        </div>
    `;

            // Add navigation event listeners
            document.getElementById("prevBadge")?.addEventListener("click", () => {
                if (currentBadgeIndex > 0) {
                    currentBadgeIndex--;
                    displayBadgeCarousel();
                }
            });

            document.getElementById("nextBadge")?.addEventListener("click", () => {
                if (currentBadgeIndex < badgeImages.length - 1) {
                    currentBadgeIndex++;
                    displayBadgeCarousel();
                }
            });

            // Update print button text
            if (badgeImages.length === 1) {
                printBtn.innerHTML = '<i class="fas fa-print me-2"></i>Print Badge';
            } else {
                printBtn.innerHTML = `<i class="fas fa-print me-2"></i>Print All ${badgeImages.length} Badges`;
            }
        }

        // Open single badge modal (original functionality)
        function openBadgeModal(regId) {
            currentBatchIds = [regId];
            currentBadgeIndex = 0;
            badgeImages = [];

            const previewContainer = document.querySelector(".badge-preview-container");
            const badgePreview = document.getElementById("badgePreview");
            const loading = document.getElementById("badgeLoading");
            const printBtn = document.getElementById("printBadgeBtn");
            const modalTitle = document.querySelector(".modal-title-main");
            const modalSubtitle = document.querySelector(".modal-subtitle");

            modalTitle.textContent = "Badge Preview";
            modalSubtitle.textContent = "Review before printing";

            previewContainer.classList.add("d-none");
            loading.classList.remove("d-none");
            printBtn.classList.add("d-none");

            const modal = new bootstrap.Modal(document.getElementById("badgeModal"));
            modal.show();

            fetch(`/create_badge/${regId}/`)
                .then((response) => response.json())
                .then((data) => {
                    if (data.image_url) {
                        badgeImages = [{id: regId, url: data.image_url}];

                        // Restore original preview structure
                        previewContainer.innerHTML = `
                    <div class="preview-frame">
                        <img id="badgePreview" src="${data.image_url}" alt="Badge" class="badge-image">
                        <div class="preview-overlay">
                            <i class="fas fa-search-plus"></i>
                        </div>
                    </div>
                `;

                        previewContainer.classList.remove("d-none");
                        loading.classList.add("d-none");
                        printBtn.classList.remove("d-none");
                        printBtn.innerHTML = '<i class="fas fa-print me-2"></i>Print Badge';
                    } else {
                        loading.innerHTML = "<p class='text-danger'>Failed to load badge.</p>";
                    }
                })
                .catch((err) => {
                    console.error("Error generating badge:", err);
                    loading.innerHTML = "<p class='text-danger'>Error generating badge.</p>";
                });
        }

        // Print all selected badges
        document.getElementById("printBadgeBtn").addEventListener("click", async function () {
            if (badgeImages.length === 0) {
                alert("No badges to print.");
                return;
            }

            const printBtn = this;
            const originalText = printBtn.innerHTML;
            printBtn.disabled = true;
            printBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Printing...';

            try {
                // Print all badges together
                await printAllBadges(badgeImages);

                // Mark all as printed
                await markAllAsPrinted(badgeImages.map(b => b.id));

                // Close modal and refresh
                const modalEl = document.getElementById("badgeModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Remove printed rows
                badgeImages.forEach(badge => {
                    const row = document.querySelector(`#row-${badge.id}`);
                    if (row) row.remove();
                });

                // Refresh page
                setTimeout(() => {
                    window.location.reload();
                }, 1500);

            } catch (err) {
                console.error("Error during printing:", err);
                alert("Some badges may not have printed correctly. Please check.");
            } finally {
                printBtn.disabled = false;
                printBtn.innerHTML = originalText;
            }
        });

        // Print all badges in a single print window
        function printAllBadges(badges) {
            return new Promise((resolve, reject) => {
                const printWindow = window.open("", "_blank", "width=800,height=1000");

                if (!printWindow) {
                    alert("Popup blocked! Allow popups for this site.");
                    reject("Popup blocked");
                    return;
                }

                // Generate HTML for all badges
                const badgeImagesHTML = badges.map((badge, index) => `
            <div class="badge-page">
                <img src="${badge.url}" alt="Badge ${index + 1}" />
            </div>
        `).join('');

                printWindow.document.open();
                printWindow.document.write(`
            <!DOCTYPE html>
            <html>
                <head>
                    <title>Print ${badges.length} Badge${badges.length > 1 ? 's' : ''}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }

                        @media print {
                            @page {
                                margin: 0;
                                size: auto;
                            }

                            body {
                                margin: 0;
                                padding: 0;
                            }

                            .print-header {
                                display: none !important;
                            }

                            .badge-page {
                                page-break-before: auto;
                                page-break-after: always;
                                page-break-inside: avoid;
                                margin: 0;
                                padding: 0;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                width: 100%;
                                height: 100vh;
                            }

                            .badge-page:last-of-type {
                                page-break-after: avoid;
                            }

                            img {
                                display: block;
                                max-width: 100%;
                                max-height: 100vh;
                                width: auto;
                                height: auto;
                                margin: auto;
                            }
                        }

                        @media screen {
                            body {
                                margin: 0;
                                padding: 20px;
                                background: #f5f5f5;
                                font-family: Arial, sans-serif;
                            }

                            .print-header {
                                background: #2980b9;
                                color: white;
                                padding: 15px;
                                text-align: center;
                                margin-bottom: 20px;
                                border-radius: 8px;
                            }

                            .badge-page {
                                background: white;
                                margin-bottom: 20px;
                                padding: 20px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                text-align: center;
                                min-height: 200px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }

                            img {
                                max-width: 100%;
                                height: auto;
                                display: block;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h2 style="margin: 0;">Badge Print Preview</h2>
                        <p style="margin: 5px 0 0 0;">Total: ${badges.length} badge${badges.length > 1 ? 's' : ''}</p>
                    </div>
                    ${badgeImagesHTML}
                    <script>
                        let imagesLoaded = 0;
                        let printTriggered = false;
                        const totalImages = ${badges.length};
                        const images = document.querySelectorAll('img');

                        images.forEach(img => {
                            if (img.complete) {
                                imagesLoaded++;
                            } else {
                                img.onload = () => {
                                    imagesLoaded++;
                                    checkAndPrint();
                                };
                                img.onerror = () => {
                                    imagesLoaded++;
                                    console.error('Failed to load image');
                                    checkAndPrint();
                                };
                            }
                        });

                        // Check if all images already loaded
                        if (imagesLoaded === totalImages) {
                            checkAndPrint();
                        }

                        function checkAndPrint() {
                            if (imagesLoaded === totalImages && !printTriggered) {
                                printTriggered = true;
                                setTimeout(() => {
                                    window.focus();
                                    window.print();
                                    setTimeout(() => {
                                        window.opener.postMessage('print_complete', '*');
                                    }, 500);
                                }, 1000);
                            }
                        }
                    <\/script>
                </body>
            </html>
        `);
                printWindow.document.close();

                // Wait for print completion message
                const messageHandler = (event) => {
                    if (event.data === 'print_complete') {
                        window.removeEventListener('message', messageHandler);
                        resolve();
                    }
                };

                window.addEventListener('message', messageHandler);

                // Timeout fallback
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    resolve();
                }, 10000); // 10 seconds timeout for multiple badges
            });
        }

        // Mark all badges as printed
        async function markAllAsPrinted(ids) {
            const promises = ids.map(id =>
                fetch(`/mark_printed/${id}/`, {
                    method: "POST",
                    headers: {"X-CSRFToken": getCSRFToken()},
                }).then(res => res.json())
            );

            try {
                const results = await Promise.all(promises);
                const allSuccess = results.every(data => data.success);

                if (!allSuccess) {
                    console.error("Some badges were not marked as printed");
                }

                return allSuccess;
            } catch (err) {
                console.error("Error marking badges as printed:", err);
                return false;
            }
        }

        // Helper: Get CSRF token
        function getCSRFToken() {
            return document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";
        }

        // Reset modal on close
        document.getElementById("badgeModal").addEventListener("hidden.bs.modal", () => {
            const previewContainer = document.querySelector(".badge-preview-container");
            previewContainer.innerHTML = `
        <div class="preview-frame">
            <img id="badgePreview" src="" alt="Badge" class="badge-image">
            <div class="preview-overlay">
                <i class="fas fa-search-plus"></i>
            </div>
        </div>
    `;
            previewContainer.classList.add("d-none");
            document.getElementById("badgeLoading").classList.remove("d-none");
            document.getElementById("printBadgeBtn").classList.add("d-none");

            currentBatchIds = [];
            currentBadgeIndex = 0;
            badgeImages = [];
        });
    </script>




{% endblock %}