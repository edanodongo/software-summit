{% extends "summit/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4 px-4">
<div class="container-fluid mt-4 px-4">
  <h2 class="fw-bold mb-4 text-primary">
    <i class="fas fa-tachometer-alt me-2"></i> Exhibitions Dashboard
  </h2>

  <!-- âœ… Success messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-1"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Dashboard Settings -->
  <div class="card p-4 mb-4 shadow-sm">
    <h5 class="mb-3">Dashboard Settings</h5>

    <!-- ðŸ§¾ Validation (non-field errors) -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
          <div><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="POST" class="row g-3">
      {% csrf_token %}
      <div class="col-md-4">
        {{ form.max_count.label_tag }}
        {{ form.max_count }}

        <!-- ðŸš¨ Field-specific validation alert -->
        {% if form.max_count.errors %}
          {% for error in form.max_count.errors %}
            <div class="alert alert-danger mt-2 py-2 px-3" role="alert">
              <i class="fas fa-exclamation-triangle me-1"></i> {{ error }}
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <div class="col-md-2 align-self-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-save me-1"></i> Update
        </button>
      </div>
    </form>
  </div>

  <!-- ðŸ“¢ Remaining Counts Alert -->
  <div class="alert {{ alert_class }} shadow-sm" role="alert">
    <strong>Notice:</strong> {{ alert_message }}
  </div>

</div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Total Exhibitors</h6>
        <h3 class="fw-bold text-primary">{{ total_exhibitors }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Total Booths</h6>
        <h3 class="fw-bold text-success">{{ max_count }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Available Booths</h6>
        <h3 class="fs-4 text-success">
            <h3 class="fw-bold text-success">{{ remaining }}</h3>
        </h3>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Booked Booths</h6>
        <h3 class="fw-bold text-danger">{{ total_count }}</h3>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-header bg-light fw-semibold">
      <i class="fas fa-filter me-2 text-primary"></i>Filters
    </div>
    <div class="card-body">
      <form method="GET" class="row g-3 align-items-center">
        <div class="col-md-3">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search by name, email, phone, or organization..."
            value="{{ query }}"
          />
        </div>

        <div class="col-md-2">
          <select name="category" class="form-select">
            <option value="">Filter by Category</option>
            {% for value, label in categories %}
              <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <select name="section" class="form-select">
            <option value="">Filter by Section</option>
            {% for s in sections %}
              <option value="{{ s.id }}" {% if section_filter|add:'' == s.id|add:'' %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
            <select name="country_of_registration" class="form-select">
              <option value="">Filter by Country</option>
              {% for code, name in available_countries %}
                <option value="{{ code }}" {% if country_filter == code %}selected{% endif %}>
                  {{ name }}
                </option>
              {% endfor %}
            </select>
        </div>

        <div class="col-md-1 d-grid">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter me-1"></i> Apply
          </button>
        </div>

        <div class="col-md-2 d-grid">
          <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-undo me-1"></i> Reset
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Recent Exhibitors -->
  <div class="card shadow-sm border-0 rounded-4 mb-5">
    <div class="card-header bg-primary text-white fw-semibold">
      <i class="fas fa-users me-2"></i>Recent Exhibitors
    </div>
    <div class="card-body p-0">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Organization</th>
            <th>Country</th>
            <th>Job Title</th>
            <th>Category</th>
            <th>Booked booths</th>
            <th>Files</th>
            <th>Date Registered</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for e in exhibitors %}
          <tr>
            <td>{{ e.get_full_name }}</td>
            <td>{{ e.email }}</td>
            <td>{{ e.phone }}</td>
            <td>{{ e.organization_type }}</td>
            <td>{{ e.get_country_of_registration_display|default:"â€”" }}</td>
            <td>{{ e.job_title|default:"â€”" }}</td>
            <td>{{ e.get_category_display|default:"â€”" }}</td>
            <td>{{ e.total_count|default:"0" }}</td>
              <td>
                {% if e.logo %}
                  <a href="{{ e.logo.url }}" target="_blank">Logo</a><br>
                {% endif %}
                {% if e.passport_photo %}
                  <a href="{{ e.passport_photo.url }}" target="_blank">Proposal</a><br>
                {% endif %}
                {% if e.national_id_scan %}
                  <a href="{{ e.national_id_scan.url }}" target="_blank">Profile</a><br>
                {% endif %}
                {% if e.business_registration_doc %}
                  <a href="{{ e.business_registration_doc.url }}" target="_blank">Tax Cert</a>
                {% endif %}
                {% if e.international_business_doc %}
                  <a href="{{ e.international_business_doc.url }}" target="_blank">Tax Cert</a>
                {% endif %}
                {% if e.beneficial_owner_doc %}
                  <a href="{{ e.beneficial_owner_doc.url }}" target="_blank">Tax Cert</a>
                {% endif %}
              </td>
            <td>{{ e.created_at|date:"M d, Y H:i" }}</td>
            <td class="text-center">
              <a href="{% url 'admin_exhibitor_delete' e.id %}" class="btn btn-sm btn-outline-danger">
                <i class="fas fa-trash"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="11" class="text-center text-muted py-3">No exhibitors registered.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(alert => {
        if (!alert.classList.contains('alert-danger')) {
          alert.classList.add('fade');
          setTimeout(() => alert.remove(), 500);
        }
      });
    }, 4000); // 4 seconds
  });
</script>
{% endblock %}