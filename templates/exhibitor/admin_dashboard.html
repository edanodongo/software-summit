{% extends "summit/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4 px-4">
<div class="container-fluid mt-4 px-4">
  <h2 class="fw-bold mb-4 text-primary">
    <i class="fas fa-tachometer-alt me-2"></i> Exhibitions Dashboard
  </h2>

  <!-- ‚úÖ Success messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-1"></i> {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Dashboard Settings -->
  <div class="card p-4 mb-4 shadow-sm">
    <h5 class="mb-3">Dashboard Settings</h5>

    <!-- üßæ Validation (non-field errors) -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
          <div><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="POST" class="row g-3">
      {% csrf_token %}
      <div class="col-md-4">
        {{ form.max_count.label_tag }}
        {{ form.max_count }}

        <!-- üö® Field-specific validation alert -->
        {% if form.max_count.errors %}
          {% for error in form.max_count.errors %}
            <div class="alert alert-danger mt-2 py-2 px-3" role="alert">
              <i class="fas fa-exclamation-triangle me-1"></i> {{ error }}
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <div class="col-md-2 align-self-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-save me-1"></i> Update
        </button>
      </div>
    </form>
  </div>

  <!-- üì¢ Remaining Counts Alert -->
  <div class="alert {{ alert_class }} shadow-sm" role="alert">
    <strong>Notice:</strong> {{ alert_message }}
  </div>

</div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Total Exhibitors</h6>
        <h3 class="fw-bold text-primary">{{ total_exhibitors }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Total Booths</h6>
        <h3 class="fw-bold text-success">{{ max_count }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Available Booths</h6>
        <h3 class="fs-4 text-success">
            <h3 class="fw-bold text-success">{{ remaining }}</h3>
        </h3>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 rounded-4 py-3">
        <h6 class="text-muted mb-1">Booked Booths</h6>
        <h3 class="fw-bold text-danger">{{ total_count }}</h3>
      </div>
    </div>
  </div>

</div>




  <!-- Filters -->
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-header bg-light fw-semibold">
      <i class="fas fa-filter me-2 text-primary"></i>Filters
    </div>
    <div class="card-body">
      <form method="GET" class="row g-3 align-items-center">
        <div class="col-md-3">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search by name, email, phone, or organization..."
            value="{{ query }}"
          />
        </div>

        <div class="col-md-2">
          <select name="category" class="form-select">
            <option value="">Filter by Category</option>
            {% for value, label in categories %}
              <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <select name="section" class="form-select">
            <option value="">Filter by Section</option>
            {% for s in sections %}
              <option value="{{ s.id }}" {% if section_filter|add:'' == s.id|add:'' %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
            <select name="country_of_registration" class="form-select">
              <option value="">Filter by Country</option>
              {% for code, name in available_countries %}
                <option value="{{ code }}" {% if country_filter == code %}selected{% endif %}>
                  {{ name }}
                </option>
              {% endfor %}
            </select>
        </div>

        <div class="col-md-1 d-grid">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter me-1"></i> Apply
          </button>
        </div>

        <div class="col-md-2 d-grid">
          <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-undo me-1"></i> Reset
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Recent Exhibitors -->
  <div class="card shadow-sm border-0 rounded-4 mb-5">
  <div class="card-header bg-primary text-white fw-semibold">
    <i class="fas fa-users me-2"></i>Recent Exhibitors
  </div>
  <div class="card-body p-0">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Organization</th>
          <th>Country</th>
          <th>Job Title</th>
          <th>Category</th>
          <th>Booked booths</th>
          <th>Files</th>
          <th>Email Attempts</th>
          <th>Email Status</th>
          <th>Last Sent</th>
          <th>Date Registered</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for e in exhibitors %}
        <tr data-exhibitor-id="{{ e.id }}">
          <td>{{ e.get_full_name }}</td>
          <td>{{ e.email }}</td>
          <td>{{ e.phone }}</td>
          <td>{{ e.organization_type }}</td>
          <td>{{ e.get_country_of_registration_display|default:"‚Äî" }}</td>
          <td>{{ e.job_title|default:"‚Äî" }}</td>
          <td>{{ e.get_category_display|default:"‚Äî" }}</td>
          <td>{{ e.total_count|default:"0" }}</td>

          <td>
            {% if e.logo %}<a href="{{ e.logo.url }}" target="_blank">Logo</a><br>{% endif %}
            {% if e.passport_photo %}<a href="{{ e.passport_photo.url }}" target="_blank">Passport</a><br>{% endif %}
            {% if e.national_id_scan %}<a href="{{ e.national_id_scan.url }}" target="_blank">ID</a><br>{% endif %}
          </td>

          <td class="text-center">{{ e.email_attempts|default:"0" }}</td>
          <td class="text-center">
            {% if e.email_status == "success" %}
              <span class="badge bg-success">Sent</span>
            {% elif e.email_status == "failed" %}
              <span class="badge bg-danger">Failed</span>
            {% else %}
              <span class="badge bg-secondary">Pending</span>
            {% endif %}
          </td>
          <td class="text-center">{{ e.email_last_sent|date:"M d, Y H:i" }}</td>
          <td>{{ e.created_at|date:"M d, Y H:i" }}</td>

          <td>
            <div class="btn-group">
              <button
                class="btn btn-sm btn-outline-primary edit-exhibitor-btn"
                data-id="{{ e.id }}">
                <i class="fas fa-edit"></i>
              </button>

              {% if e.approval_status == "approved" %}
                <span class="badge bg-success">Approved</span>
              {% elif e.approval_status == "pending" %}
                <button
                  class="btn btn-sm btn-outline-success approve-btn"
                  data-id="{{ e.id }}"
                  data-name="{{ e.get_full_name }}"
                  data-organization="{{ e.organization_type }}"
                  data-email="{{ e.email|default:'N/A' }}"
                  data-remaining="{{ remaining }}">
                  <i class="fas fa-check"></i> Approve
                </button>
              {% else %}
                <span class="badge bg-danger">Rejected</span>
              {% endif %}



              <a href="{% url 'admin_exhibitor_delete' e.id %}" class="btn btn-sm btn-outline-danger">
                <i class="fas fa-trash"></i>
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="14" class="text-center text-muted py-3">No exhibitors registered.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="dynamicModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-3 shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title">Edit Exhibitor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Form will load dynamically here -->
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Approval Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">

      <!-- Header -->
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle me-1"></i> Approve Exhibitor
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- ‚úÖ Dynamic Exhibitor Info -->
        <div class="mb-3">
          <h5 id="exhibitorName" class="fw-bold text-primary mb-2"></h5>
          <p class="mb-1"><strong>Organization:</strong> <span id="exhibitorOrganization">‚Äî</span></p>
          <p class="mb-1"><strong>Email:</strong> <span id="exhibitorEmail">‚Äî</span></p>
          <p class="text-muted"><strong>Remaining Booths:</strong> <span id="remainingBooths">0</span></p>
        </div>

        <!-- ‚úÖ Approval Form -->
        <form id="approveForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="boothCount" class="form-label">Booth Count to Approve</label>
            <input type="number" id="boothCount" name="count" class="form-control" min="1" required>
          </div>

          <input type="hidden" id="approveExhibitorId" name="exhibitor_id">

          <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check2-circle me-1"></i> Approve Exhibitor
            </button>
          </div>
        </form>

        <!-- ‚úÖ Success Message (hidden by default) -->
        <div id="approvalSuccess" class="alert alert-success mt-3 text-center d-none">
          Exhibitor approved successfully!
        </div>
      </div>
    </div>
  </div>
</div>


</div>
{% endblock %}

{% block scripts %}
<style>
        #registrants-table {
            width: 100% !important;
            font-size: 0.9rem;
            table-layout: auto;
            border-spacing: 0 4px;
        }

        #registrants-table th, #registrants-table td {
            padding: 0.55rem 0.75rem !important;
            white-space: nowrap;
        }

        #registrants-table tfoot input {
            width: 100%;
            padding: 2px 6px;
            font-size: 0.8rem;
        }

        .truncate {
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bg-success-subtle {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }

        .bg-danger-subtle {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }

        .bg-secondary-subtle {
            background-color: rgba(108, 117, 125, 0.1) !important;
        }

        .bg-info-subtle {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
        #editRegistrantModal .modal-content {
          border-radius: 1rem;
          overflow: hidden;
        }

        #editRegistrantModal .form-control,
        #editRegistrantModal select {
          border-radius: 0.5rem;
          box-shadow: none !important;
        }

        .toast {
          z-index: 20000;
        }

</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(alert => {
        if (!alert.classList.contains('alert-danger')) {
          alert.classList.add('fade');
          setTimeout(() => alert.remove(), 500);
        }
      });
    }, 4000); // 4 seconds
  });


document.addEventListener("DOMContentLoaded", function() {
  const forms = document.querySelectorAll(".resend-email-form");

  forms.forEach(form => {
    form.addEventListener("submit", async function(e) {
      e.preventDefault(); // Stop normal page reload

      const button = form.querySelector(".resend-btn");
      const tr = form.closest("tr");
      const attemptsCell = tr.querySelector(".email-attempts");
      const statusCell = tr.querySelector(".email-status");
      const lastSentCell = tr.querySelector(".email-last-sent");

      // Show loading spinner
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      try {
        const response = await fetch(form.action, {
          method: "POST",
          headers: {
            "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
          }
        });
        const data = await response.json();

        // ‚úÖ Update UI dynamically
        if (data.success) {
          attemptsCell.textContent = data.attempts ?? "‚Äî";
          lastSentCell.textContent = data.last_sent ?? "‚Äî";

          if (data.status === "success") {
            statusCell.innerHTML = '<span class="badge bg-success-subtle text-success border border-success px-2">Sent</span>';
          } else if (data.status === "failed") {
            statusCell.innerHTML = '<span class="badge bg-danger-subtle text-danger border border-danger px-2">Failed</span>';
          } else {
            statusCell.innerHTML = `<span class="badge bg-secondary-subtle text-secondary border border-secondary px-2">${data.status}</span>`;
          }

          // Small success highlight
          tr.style.transition = "background-color 0.3s";
          tr.style.backgroundColor = "#e6ffed";
          setTimeout(() => (tr.style.backgroundColor = ""), 1000);
        } else {
          alert("‚ùå " + (data.error || "Email failed to send."));
        }
      } catch (err) {
        alert("‚ö†Ô∏è Error sending email. Please try again.");
      } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-envelope"></i>';
      }
    });
  });
});

document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("dynamicModal");
  const modalBody = modal.querySelector(".modal-body");

  // Open edit modal
  document.querySelectorAll(".edit-exhibitor-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/edit-exhibitor/${id}/`);
      const data = await res.json();
      modalBody.innerHTML = data.html_form;
      new bootstrap.Modal(modal).show();

      bindExhibitorForm();
    });
  });

  function bindExhibitorForm() {
    const form = modalBody.querySelector("#edit-exhibitor-form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const res = await fetch(form.action, {
        method: "POST",
        body: new FormData(form),
      });

      const data = await res.json();
      if (data.success) {
        const row = document.querySelector(`tr[data-exhibitor-id="${data.id}"]`);
        row.outerHTML = data.row_html;
        bootstrap.Modal.getInstance(modal).hide();
      } else {
        modalBody.innerHTML = data.html_form;
        bindExhibitorForm();
      }
    });
  }
});
document.addEventListener("DOMContentLoaded", function () {
  const approveModal = new bootstrap.Modal(document.getElementById("approveModal"));
  const approveForm = document.getElementById("approveForm");

  const exhibitorName = document.getElementById("exhibitorName");
  const exhibitorOrganization = document.getElementById("exhibitorOrganization");
  const exhibitorEmail = document.getElementById("exhibitorEmail");
  const remainingBooths = document.getElementById("remainingBooths");

  const boothCount = document.getElementById("boothCount");
  const approveExhibitorId = document.getElementById("approveExhibitorId");
  const approveButton = approveForm.querySelector("button[type='submit']");

  // ‚úÖ Open modal when clicking "Approve"
  document.querySelectorAll(".approve-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      const row = this.closest("tr");

      // Extract data from dataset or table columns
      const name = row.querySelector("td:first-child").textContent.trim();
      const organization = this.dataset.organization || row.querySelector(".org-col")?.textContent?.trim() || "N/A";
      const email = this.dataset.email || row.querySelector(".email-col")?.textContent?.trim() || "N/A";
      const remaining = this.dataset.remaining || document.getElementById("remainingBoothsCount")?.textContent || "‚Äî";

      // Fill modal fields
      exhibitorName.textContent = `Approve ${name}?`;
      exhibitorOrganization.textContent = organization;
      exhibitorEmail.textContent = email;
      remainingBooths.textContent = remaining;

      approveExhibitorId.value = this.dataset.id;
      boothCount.value = 1; // default booth count

      approveModal.show();
    });
  });

  // ‚úÖ Submit approval via AJAX
  approveForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const exhibitorId = approveExhibitorId.value;
    const count = boothCount.value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- Loading spinner ---
    approveButton.disabled = true;
    const originalText = approveButton.innerHTML;
    approveButton.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> Approving...`;

    try {
      const response = await fetch(`/ajax/approve/${exhibitorId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ count }),
      });

      const data = await response.json();

      if (data.success) {
        // ‚úÖ Update exhibitor row instantly
        const row = document.querySelector(`tr[data-exhibitor-id='${data.id}']`);
        if (row) {
          row.querySelector("td:nth-child(8)").textContent = data.total_count;
          row.querySelector(".approve-btn").outerHTML = `
            <span class="badge bg-success px-3 py-2">Approved</span>
          `;
        }

        // ‚úÖ Update dashboard stats (if visible)
        const approvedExhibitorsCount = document.getElementById("approvedExhibitorsCount");
        const approvedBoothsTotal = document.getElementById("approvedBoothsTotal");
        const remainingEl = document.getElementById("remainingBoothsCount");

        if (approvedExhibitorsCount)
          approvedExhibitorsCount.textContent = parseInt(approvedExhibitorsCount.textContent || 0) + 1;

        if (approvedBoothsTotal)
          approvedBoothsTotal.textContent = parseInt(approvedBoothsTotal.textContent || 0) + parseInt(data.total_count);

        if (remainingEl)
          remainingEl.textContent = parseInt(data.remaining);

        // ‚úÖ Button success feedback
        approveButton.innerHTML = `<i class="bi bi-check-circle"></i> Approved!`;
        approveButton.classList.replace("btn-success", "btn-primary");

        // ‚úÖ Close modal after short delay
        setTimeout(() => {
          approveModal.hide();
          approveForm.reset();
          approveButton.disabled = false;
          approveButton.innerHTML = originalText;
          approveButton.classList.replace("btn-primary", "btn-success");
        }, 1000);
      } else {
        alert(data.message || "Approval failed.");
        approveButton.disabled = false;
        approveButton.innerHTML = originalText;
      }
    } catch (err) {
      console.error("Error:", err);
      alert("Error approving exhibitor.");
      approveButton.disabled = false;
      approveButton.innerHTML = originalText;
    }
  });
});

</script>


{% endblock %}