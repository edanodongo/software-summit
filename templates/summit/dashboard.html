{% extends "summit/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4 px-4">

  <h2 class="fw-bold mb-4 text-primary">Delegates Dashboard</h2>

  <!-- Summary Cards -->
  <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
    <div class="col">
      <div class="card shadow-sm border-0 rounded-4 h-100">
        <div class="card-body text-center py-4">
          <h5 class="text-muted mb-2">Total Delegates</h5>
          <p class="display-5 fw-bold text-primary mb-1" id="total-users">{{ total_users }}</p>
          <h6 class="text-secondary mb-0">
            Updates Opt-in:
            <span class="fw-semibold text-success" id="updates-count">{{ updates_count }}</span>
          </h6>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card shadow-sm border-0 rounded-4 h-100">
        <div class="card-body text-center py-4">
          <h5 class="text-muted mb-2">Total Registrations</h5>
          <p class="display-5 fw-bold text-primary mb-1">{{ registrations.count }}</p>
          <h6 class="text-secondary mb-0">
            Updates Opt-in:
            <span class="fw-semibold text-success">{{ updates_count }}</span>
          </h6>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex justify-content-end align-items-center mb-3 flex-wrap gap-2">
    <a href="{% url 'export_print' %}" target="_blank" class="btn btn-outline-danger btn-sm shadow-sm">
      <i class="fas fa-print me-1"></i> Print View
    </a>
    <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#batchModal">
      <i class="fas fa-layer-group me-1"></i> Generate Batch ZIPs
    </a>
    <a href="{% url 'generate_all_reg_badges' %}" class="btn btn-secondary btn-sm shadow-sm">
      <i class="fas fa-archive me-1"></i> Download All
    </a>
  </div>

  <!-- Registrants Table -->
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-header bg-primary text-white fw-semibold rounded-top-4">
      <i class="fas fa-users me-2"></i>Recent Registrations
    </div>
    <div class="card-body p-3">
      <div class="table-responsive">
        <table id="registrants-table" class="table table-hover align-middle table-borderless w-100">
          <thead class="table-primary text-white">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Organization</th>
              <th>Org. Type</th>
              <th>Job Title</th>
              <th>Category</th>
              <th>Days</th>
              <th>National ID</th>
              <th>ID Scan</th>
              <th>Passport</th>
              <th>Interests</th>
              <th>Privacy</th>
              <th>Email Attempts</th>
              <th>Email Status</th>
              <th>Last Sent</th>
              <th>Registered</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for registrant in registrants %}
              <tr id="row-{{ registrant.id }}">
                <td>{{ forloop.counter0|add:start_index|add:"1" }}</td>
                <td class="fw-semibold">{{ registrant.get_full_name }}</td>
                <td>{{ registrant.email }}</td>
                <td>{{ registrant.phone }}</td>
                <td>{{ registrant.display_org_type }}</td>
                <td>{{ registrant.get_organization_type_display }}</td>
                <td>{{ registrant.job_title|default:"—" }}</td>
                <td>{{ registrant.category_name|default:"—" }}</td>
                <td>{{ registrant.days_to_attend|default:"—" }}</td>
                <td>{{ registrant.national_id_number|default:"—" }}</td>

                <td>
                  {% if registrant.national_id_scan %}
                    <a href="{{ registrant.national_id_scan.url }}" target="_blank" class="text-primary">
                      <i class="fas fa-file-pdf"></i> View
                    </a>
                  {% else %}—{% endif %}
                </td>

                <td>
                  {% if registrant.passport_photo %}
                    <a href="{{ registrant.passport_photo.url }}" target="_blank">
                      <img src="{{ registrant.passport_photo.url }}" style="height:35px;width:35px;border-radius:50%;object-fit:cover;">
                    </a>
                  {% else %}—{% endif %}
                </td>

                <td class="truncate">{{ registrant.display_interests|default:"—" }}</td>

                <td class="text-center">
                  {% if registrant.privacy_agreed %}
                    <i class="fas fa-check-circle text-success"></i>
                  {% else %}
                    <i class="fas fa-times-circle text-danger"></i>
                  {% endif %}
                </td>

                <td class="text-center email-attempts">
                  <span class="badge bg-info-subtle text-info border border-info px-2">
                    {{ registrant.email_attempts|default:"0" }}
                  </span>
                </td>

                <td class="text-center email-status">
                  {% if registrant.email_status|lower == "success" %}
                    <span class="badge bg-success-subtle text-success border border-success px-2">Sent</span>
                  {% elif registrant.email_status|lower == "failed" %}
                    <span class="badge bg-danger-subtle text-danger border border-danger px-2">Failed</span>
                  {% else %}
                    <span class="badge bg-secondary-subtle text-secondary border border-secondary px-2">
                      {{ registrant.email_status|default:"Pending"|capfirst }}
                    </span>
                  {% endif %}
                </td>

                <td class="text-center email-last-sent">
                  {{ registrant.email_last_sent|date:"M d, Y H:i"|default:"—" }}
                </td>

                <td>{{ registrant.created_at|date:"M d, Y H:i" }}</td>

                <td>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-warning edit-btn" data-id="{{ registrant.id }}" data-url="{% url 'edit_registrant_modal' registrant.id %}">
                      <i class="fas fa-edit"></i>
                    </button>
                    <a href="{% url 'generate_badge' registrant.id %}" target="_blank" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-id-badge"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-success resend-btn" data-url="{% url 'resend_confirmation_email' registrant.id %}">
                      <i class="fas fa-envelope"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" data-url="{% url 'delete_registrant' registrant.id %}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="19" class="text-center py-4 text-muted">No registrations yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
          <div class="d-flex justify-content-center mt-4">
              <nav aria-label="Registrants pagination">
                <ul class="pagination">
                  {% if registrants.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ registrants.previous_page_number }}">Previous</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                  {% endif %}

                  {% for num in registrants.paginator.page_range %}
                    {% if registrants.number == num %}
                      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                      <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                  {% endfor %}

                  {% if registrants.has_next %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ registrants.next_page_number }}">Next</a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                  {% endif %}
                </ul>
              </nav>
</div>

      </div>

      <!-- Django Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap">
        <div class="text-muted small">
          Showing {{ registrants.start_index }}–{{ registrants.end_index }} of {{ registrants.paginator.count }} entries
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Keep your Modals and Scripts sections here (unchanged) -->
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{% static 'datatables/css/jquery.dataTables.min.css' %}">
<link rel="stylesheet" href="{% static 'datatables/css/buttons.dataTables.min.css' %}">
<script src="{% static 'datatables/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'datatables/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'datatables/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'datatables/js/buttons.print.min.js' %}"></script>
<script src="{% static 'datatables/js/jszip.min.js' %}"></script>
<script src="{% static 'datatables/js/pdfmake.min.js' %}"></script>
<script src="{% static 'datatables/js/vfs_fonts.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const table = $('#registrants-table').DataTable({
    dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt',
    paging: false,  // handled by Django
    info: false,
    buttons: [
      {extend: 'copy', text: '<i class="fas fa-copy"></i> Copy'},
      {extend: 'csv', text: '<i class="fas fa-file-csv"></i> CSV'},
      {extend: 'excel', text: '<i class="fas fa-file-excel"></i> Excel'},
      {extend: 'pdf', text: '<i class="fas fa-file-pdf"></i> PDF'},
      {extend: 'print', text: '<i class="fas fa-print"></i> Print'}
    ],
    order: [[17, 'desc']]
  });

  // Per-column filters
  $('#registrants-table tfoot input').on('keyup change', function() {
    table.column($(this).parent().index()).search(this.value).draw();
  });
});
</script>
{% endblock %}
