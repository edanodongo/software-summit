{% extends "summit/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <h2 class="fw-bold mb-4 text-primary">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
    </h2>

    <!-- Summary Card -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body text-center py-4">
                    <h5 class="text-muted mb-2">Total Registrations</h5>
                    <p class="display-5 fw-bold text-primary mb-1" id="total-users">{{ total_users }}</p>
                    <h6 class="text-secondary">
                        Updates Opt-in:
                        <span class="fw-semibold text-success" id="updates-count">{{ updates_count }}</span>
                    </h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-end mb-3 gap-2">
        <a href="{% url 'export_print' %}" target="_blank" class="btn btn-outline-danger btn-sm shadow-sm">
            <i class="fas fa-print me-1"></i> Print View
        </a>
    </div>

    <!-- Registrants Table -->
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-primary text-white fw-semibold rounded-top-4">
            <i class="fas fa-users me-2"></i>Recent Registrations
        </div>
        <div class="card-body p-3">
            <div class="table-responsive">
                <table id="registrants-table" class="table table-hover align-middle table-borderless w-100">
                    <thead class="table-primary text-white">
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Organization</th>
                            <th>Org. Type</th>
                            <th>Job Title</th>
                            <th>Category</th>
                            <th>National ID</th>
                            <th>ID Scan</th>
                            <th>Passport</th>
                            <th>Interests</th>
                            <th>Privacy</th>
                            <th>Email Attempts</th>
                            <th>Email Status</th>
                            <th>Last Sent</th>
                            <th>Registered At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registrant in registrants %}
                        <tr id="row-{{ registrant.id }}">
                            <td class="fw-semibold">{{ registrant.get_full_name }}</td>
                            <td>{{ registrant.email }}</td>
                            <td>{{ registrant.phone }}</td>
                            <td>{{ registrant.display_org_type }}</td>
                            <td>{{ registrant.get_organization_type_display }}</td>
                            <td class="truncate">{{ registrant.job_title|default:"—" }}</td>
                            <td>{{ registrant.get_category_display|default:"—" }}</td>
                            <td>{{ registrant.national_id_number|default:"—" }}</td>
                            <td>
                                {% if registrant.national_id_scan %}
                                    <a href="{{ registrant.national_id_scan.url }}" target="_blank" class="text-decoration-none text-primary">
                                        <i class="fas fa-file-pdf"></i> View
                                    </a>
                                {% else %}—{% endif %}
                            </td>
                            <td>
                                {% if registrant.passport_photo %}
                                    <a href="{{ registrant.passport_photo.url }}" target="_blank">
                                        <img src="{{ registrant.passport_photo.url }}" alt="Passport" style="height:35px;width:35px;border-radius:50%;object-fit:cover;">
                                    </a>
                                {% else %}—{% endif %}
                            </td>
                            <td class="truncate">{{ registrant.display_interests|default:"—" }}</td>
                            <td class="text-center">
                                {% if registrant.privacy_agreed %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% else %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                {% endif %}
                            </td>
                            <td class="text-center email-attempts">
                                <span class="badge bg-info-subtle text-info border border-info px-2">{{ registrant.email_attempts|default:"0" }}</span>
                            </td>
                            <td class="text-center email-status">
                                {% if registrant.email_status %}
                                    {% if registrant.email_status|lower == "success" %}
                                        <span class="badge bg-success-subtle text-success border border-success px-2">Sent</span>
                                    {% elif registrant.email_status|lower == "failed" %}
                                        <span class="badge bg-danger-subtle text-danger border border-danger px-2">Failed</span>
                                    {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary px-2">{{ registrant.email_status|capfirst }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary border border-secondary px-2">Pending</span>
                                {% endif %}
                            </td>
                            <td class="text-center email-last-sent">
                                {% if registrant.email_last_sent %}
                                    {{ registrant.email_last_sent|date:"M d, Y H:i" }}
                                {% else %}—{% endif %}
                            </td>
                            <td>{{ registrant.created_at|date:"M d, Y H:i" }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'generate_badge' registrant.id %}" class="btn btn-sm btn-outline-primary" target="_blank" title="Badge">
                                        <i class="fas fa-id-badge"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-success resend-btn" data-url="{% url 'resend_confirmation_email' registrant.id %}" title="Resend Email">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-url="{% url 'delete_registrant' registrant.id %}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="17" class="text-center py-4 text-muted">No registrations yet.</td></tr>
                        {% endfor %}
                    </tbody>
                    <!-- 🔽 Filter Row -->
                    <tfoot>
    <tr>
        <th><input type="text" placeholder="Filter Name" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Email" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Phone" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Organization" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Org. Type" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Job Title" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Category" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter National ID" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter ID Scan" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Passport" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Interests" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Privacy" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Email Attempts" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Email Status" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Last Sent" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Registered At" class="form-control form-control-sm" /></th>
        <th><input type="text" placeholder="Filter Action" class="form-control form-control-sm" /></th>
    </tr>
</tfoot>

                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title" id="deleteConfirmLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                    <p class="mb-0">Are you sure you want to delete this registrant?</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<style>
#registrants-table { width:100%!important; font-size:0.9rem; table-layout:auto; border-spacing:0 4px; }
#registrants-table th, #registrants-table td { padding:0.55rem 0.75rem!important; white-space:nowrap; }
#registrants-table tfoot input { width:100%; padding:2px 6px; font-size:0.8rem; }
.truncate { max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.bg-success-subtle { background-color:rgba(25,135,84,0.1)!important; }
.bg-danger-subtle { background-color:rgba(220,53,69,0.1)!important; }
.bg-secondary-subtle { background-color:rgba(108,117,125,0.1)!important; }
.bg-info-subtle { background-color:rgba(13,202,240,0.1)!important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const table = $('#registrants-table').DataTable({
        dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rtip',
        buttons: [
            { extend: 'copy', text: '<i class="fas fa-copy"></i> Copy' },
            { extend: 'csv', text: '<i class="fas fa-file-csv"></i> CSV' },
            { extend: 'excel', text: '<i class="fas fa-file-excel"></i> Excel' },
            { extend: 'pdf', text: '<i class="fas fa-file-pdf"></i> PDF' },
            { extend: 'print', text: '<i class="fas fa-print"></i> Print' }
        ],
        order: [[15, 'desc']]
    });

    // 🔽 Enable per-column filters
    $('#registrants-table tfoot th').each(function () {
        const input = $(this).find('input');
        if (input.length) {
            $(input).on('keyup change', function () {
                if (table.column($(this).parent().index()).search() !== this.value) {
                    table.column($(this).parent().index()).search(this.value).draw();
                }
            });
        }
    });

    // Delete logic
    let deleteUrl="", deleteRow=null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    $('#registrants-table').on('click', '.delete-btn', function(){
        deleteUrl = $(this).data('url');
        deleteRow = $(this).closest('tr');
        deleteModal.show();
    });

    $('#confirmDeleteBtn').on('click', function(){
        $.ajax({
            url: deleteUrl, type: 'POST', headers: {'X-CSRFToken': csrftoken},
            success: function(resp){
                if(resp.success){
                    deleteModal.hide();
                    deleteRow.fadeOut(300,function(){ table.row(deleteRow).remove().draw(false); });
                } else alert("⚠️ "+(resp.error || "Could not delete."));
            },
            error: function(xhr){ alert("❌ Server Error: "+xhr.status+" - "+xhr.statusText); }
        });
    });

    // Resend logic
    $('#registrants-table').on('click', '.resend-btn', function(){
        const btn = $(this);
        const row = btn.closest('tr');
        const url = btn.data('url');
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        $.ajax({
            url: url, type: 'POST', headers: {'X-CSRFToken': csrftoken},
            success: function(data){
                if(data.success){
                    row.find('.email-attempts span').text(data.attempts || '0');
                    row.find('.email-status').html('<span class="badge bg-success-subtle text-success border border-success px-2">Sent</span>');
                    row.find('.email-last-sent').text(data.last_sent || '—');
                } else alert("⚠️ "+(data.error || "Failed to resend email."));
            },
            complete: function(){ btn.prop('disabled', false).html('<i class="fas fa-envelope"></i>'); }
        });
    });
});
</script>
{% endblock %}
